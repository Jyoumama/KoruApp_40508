<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>KORURU</title>
  <%= stylesheet_link_tag 'orders/index' %>
  <script src="https://kit.fontawesome.com/f325ea1c55.js" crossorigin="anonymous"></script>
  <script src="https://js.pay.jp/v2/pay.js"></script>
</head>
<body class="orders-index">
  <div class="container">
    <div class="row">
      <div class="col-12 text-center title">
        <h1>äºˆç´„ç¢ºèªç”»é¢</h1>
      </div>

      <div class="col-12 mt-3 text-center content">
        <div>
          <% if flash[:notice] %>
            <div class="alert alert-success"><%= flash[:notice] %></div>
          <% end %>
          <label><strong>å¸­ã®ã‚¿ã‚¤ãƒ—ï¼š</strong></label>
          <p style="display:inline;"><%= @reservation.seat_type.name %></p>
        </div>
        <div>
          <label><strong>æ—¥ä»˜ï¼š</strong></label>
          <p style="display:inline;"><%= @reservation.day %></p>
        </div>
        <div>
          <label><strong>æ™‚é–“ï¼š</strong></label>
          <p style="display:inline;"><%= @reservation.time %></p>
        </div>
        <div class="explain">
          <h3>äºˆç´„å®Œäº†ã—ã¾ã—ãŸã€‚Koruruãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ã‚¹ãƒšãƒ¼ã‚¹ã®ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ˜Š 
            <p>æ–™é‡‘ã¯ã€ç›´æ¥åº—èˆ—ã«ã¦ãŠæ”¯æ‰•ã„ä¸‹ã•ã„</p>
          </h3>
        </div>
      </div>

      <div class="col-12 text-right">
        <div class="buy-btn">
             <button id="open-payment-modal">è³¼å…¥</button>
        </div>
      </div>
    </div>
  </div>

  <div id="payment-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <form id="payment-form">
        <input type="text" id="card-number" placeholder="ã‚«ãƒ¼ãƒ‰ç•ªå·" value="4242424242424242">
        <input type="text" id="cvc" placeholder="CVC" value="123">
        <input type="text" id="exp-month" placeholder="æœ‰åŠ¹æœŸé™ï¼ˆæœˆï¼‰" value="12">
        <input type="text" id="exp-year" placeholder="æœ‰åŠ¹æœŸé™ï¼ˆå¹´ï¼‰" value="<%= Time.now.year + 1 %>">
        <input type="text" id="amount" placeholder="é‡‘é¡">
        <input type="hidden" id="reservation_id" value="<%= @reservation.id %>">
        <button type="submit">æ”¯æ‰•ã†</button>
      </form>
    </div>
  </div>

   <script>
    document.addEventListener("turbo:load", function() {
      const payjpPublicKey = document.body.getAttribute('data-payjp-public-key');
      const payjp = Payjp(payjpPublicKey); // 
      
    // ã“ã“ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ
      const openButton = document.getElementById('open-payment-modal');
      const modal = document.getElementById('payment-modal');
      const closeButton = document.getElementsByClassName('close')[0];

      openButton.onclick = function() {
        modal.style.display = 'block';
      }

      closeButton.onclick = function() {
        modal.style.display = 'none';
      }

      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      }
      // ã“ã“ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ

      const form = document.getElementById('payment-form');
      form.addEventListener('submit', async function(event) {
        event.preventDefault();

        const card = {
          number: document.getElementById('card-number').value,
          cvc: document.getElementById('cvc').value,
          exp_month: document.getElementById('exp-month').value,
          exp_year: document.getElementById('exp-year').value,
        };

        try {
          const result = await payjp.createToken(card);
          if (result.error) {
            console.error(result.error.message);
          } else {
            const token = result.id;
            const amount = document.getElementById('amount').value;
            const reservationId = document.getElementById('reservation_id').value;

            // ã‚µãƒ¼ãƒãƒ¼ã«ãƒˆãƒ¼ã‚¯ãƒ³ã¨é‡‘é¡ã‚’é€ä¿¡
            const hiddenToken = document.createElement('input');
            hiddenToken.type = 'hidden';
            hiddenToken.name = 'payjpToken';
            hiddenToken.value = token;

            const hiddenAmount = document.createElement('input');
            hiddenAmount.type = 'hidden';
            hiddenAmount.name = 'amount';
            hiddenAmount.value = amount;

            const hiddenReservationId = document.createElement('input');
            hiddenReservationId.type = 'hidden';
            hiddenReservationId.name = 'reservation_id';
            hiddenReservationId.value = reservationId;

            form.appendChild(hiddenToken);
            form.appendChild(hiddenAmount);
            form.appendChild(hiddenReservationId);
            form.action = '/orders/create'; // ã‚µãƒ¼ãƒãƒ¼ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
            form.submit();
          }
        } catch (error) {
          console.error(error);
        }
      });
    });
  </script>
</body>
</html>

