<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>KORURU</title>
  <%= stylesheet_link_tag 'orders/index' %>
  <script src="https://kit.fontawesome.com/f325ea1c55.js" crossorigin="anonymous"></script>
  <script src="https://js.pay.jp/v2/pay.js"></script>
</head>
<body class="orders-index">
  <div class="container">
    <div class="row">
      <div class="col-12 text-center title">
        <h1>予約確認画面</h1>
      </div>

      <div class="col-12 mt-3 text-center content">
        <div>
          <% if flash[:notice] %>
            <div class="alert alert-success"><%= flash[:notice] %></div>
          <% end %>
          <label><strong>席のタイプ：</strong></label>
          <p style="display:inline;"><%= @reservation.seat_type.name %></p>
        </div>
        <div>
          <label><strong>日付：</strong></label>
          <p style="display:inline;"><%= @reservation.day %></p>
        </div>
        <div>
          <label><strong>時間：</strong></label>
          <p style="display:inline;"><%= @reservation.time %></p>
        </div>
        <div class="explain">
          <h3>予約完了しました。Koruruワーキングスペースのご利用ありがとうございます😊 
            <p>料金は、直接店舗にてお支払い下さい</p>
          </h3>
        </div>
      </div>

      <div class="col-12 text-right">
        <div class="buy-btn">
             <button id="open-payment-modal">購入</button>
        </div>
      </div>
    </div>
  </div>

  <div id="payment-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <form id="payment-form">
        <input type="text" id="card-number" placeholder="カード番号" value="4242424242424242">
        <input type="text" id="cvc" placeholder="CVC" value="123">
        <input type="text" id="exp-month" placeholder="有効期限（月）" value="12">
        <input type="text" id="exp-year" placeholder="有効期限（年）" value="<%= Time.now.year + 1 %>">
        <input type="text" id="amount" placeholder="金額">
        <input type="hidden" id="reservation_id" value="<%= @reservation.id %>">
        <button type="submit">支払う</button>
      </form>
    </div>
  </div>

   <script>
    document.addEventListener("turbo:load", function() {
      const payjpPublicKey = document.body.getAttribute('data-payjp-public-key');
      const payjp = Payjp(payjpPublicKey); // 
      
    // ここが変更されました
      const openButton = document.getElementById('open-payment-modal');
      const modal = document.getElementById('payment-modal');
      const closeButton = document.getElementsByClassName('close')[0];

      openButton.onclick = function() {
        modal.style.display = 'block';
      }

      closeButton.onclick = function() {
        modal.style.display = 'none';
      }

      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      }
      // ここが変更されました

      const form = document.getElementById('payment-form');
      form.addEventListener('submit', async function(event) {
        event.preventDefault();

        const card = {
          number: document.getElementById('card-number').value,
          cvc: document.getElementById('cvc').value,
          exp_month: document.getElementById('exp-month').value,
          exp_year: document.getElementById('exp-year').value,
        };

        try {
          const result = await payjp.createToken(card);
          if (result.error) {
            console.error(result.error.message);
          } else {
            const token = result.id;
            const amount = document.getElementById('amount').value;
            const reservationId = document.getElementById('reservation_id').value;

            // サーバーにトークンと金額を送信
            const hiddenToken = document.createElement('input');
            hiddenToken.type = 'hidden';
            hiddenToken.name = 'payjpToken';
            hiddenToken.value = token;

            const hiddenAmount = document.createElement('input');
            hiddenAmount.type = 'hidden';
            hiddenAmount.name = 'amount';
            hiddenAmount.value = amount;

            const hiddenReservationId = document.createElement('input');
            hiddenReservationId.type = 'hidden';
            hiddenReservationId.name = 'reservation_id';
            hiddenReservationId.value = reservationId;

            form.appendChild(hiddenToken);
            form.appendChild(hiddenAmount);
            form.appendChild(hiddenReservationId);
            form.action = '/orders/create'; // サーバーのエンドポイント
            form.submit();
          }
        } catch (error) {
          console.error(error);
        }
      });
    });
  </script>
</body>
</html>

